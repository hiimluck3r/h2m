---
- hosts: cluster #change to all
  
  pre_tasks:
    - name: Populate service facts
      ansible.builtin.service_facts:
    
    - name: Install python3-pip
      ansible.builtin.apt:
        name: "python3-pip"
        state: present

    - name: Install pre-requisites
      ansible.builtin.pip:
        name:
          - kubernetes
          - pyyaml
          - jsonpatch

    - name: Install helm if not exists
      unarchive:
        src: https://get.helm.sh/helm-v3.11.0-linux-amd64.tar.gz
        dest: /usr/local/bin
        extra_opts: "--strip-components=1"
        owner: {{ user }}
        group: {{ user }}
        mode: 0755
        remote_src: true
      args:
        creates: /usr/local/bin/helm

  roles:
    - init
    - apps